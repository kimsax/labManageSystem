{extend name="Administrator/nav"}
{block name="title"}班级管理{/block}
{block name="content"}
<div class="row">
    <div class="col-md-12">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <form class="form-inline" action="{:url()}">
                        <div class="form-group">
                            <label class="sr-only" for="name">班级管理</label>
                            <input name="name" type="text" class="form-control" placeholder="班级名称..." value="{:input('get.name')}">
                        </div>
                        <button type="submit" class="btn btn-default"><i class="glyphicon glyphicon-search"></i>&nbsp;查询
                        </button>
                    </form>
                </div>
                <div class="col-md-4 text-right">
                    <button class="btn btn-primary" data-toggle="modal" data-target="#mymodal-data"><i
                            class="glyphicon glyphicon-plus"></i>&nbsp;增加
                    </button>
                    <div class="modal bs-example-modal-lg" id="mymodal-data" tabindex="-1" role="dialog"
                         aria-labelledby="mySmallModalLabel" aria-hidden="true">
                        <div class="modal-dialog  modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span
                                            class="sr-only">Close</span></button>
                                    <h4 class="modal-title text-left">增加班级</h4>
                                </div>
                                <div class="modal-body text-left">
                                    <form action="{:url('insert')}" method="post" class="form-inline">
                                        <label>学院</label>
                                        <select id="college" class="form-control" onclick="getMajor()">
                                            {volist name="colleges" id = "College"}
                                            <option value="{$College->id}">{$College->name}</option>
                                            {/volist}
                                        </select>
                                        <label>专业</label>
                                        <select id="major" class="form-control" onclick="getGrade()">
                                            <option>
                                            </option>
                                        </select>
                                        <label>年级：</label>
                                        <select id="grade" class="form-control" onclick="getKlass()">
                                            <option>
                                            </option>
                                        </select>
                                        <label>班级：</label>
                                        <input type="text" name="name">
                                        <button type="submit" class="btn btn-primary">保存</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <br><br>
            <form action="{:url('index')}" method="post" class="form-inline">
                <div class="row">
                    <div class="col-md-3">
                        <label>学院:</label>
                        <select class="form-control" name="searchCollegeId" id="college2" onclick="getMajor1()">
                            {volist name="colleges" id="College"}
                            <option value="{$College->id}">{$College->name}</option>
                            {/volist}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>专业：</label>
                        <select class="form-control" name="searchMajor" id="major2" onclick="getGrade1()">
                           <option></option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>年级：</label>
                        <select class="form-control" name="searchGradeId" id="grade2" onclick="getKlass1()">
                            <option></option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-default">搜索</button>
                    </div>
                </div>
            </form>

            <hr/>
            <table class="table table-hover table-bordered">
                <tr class="info">
                    <th width="10%">ID</th>
                    <th width="70%">班级名称</th>
                    <th width="20%">操作</th>
                </tr>
                {volist name="klasses" id="_Klass" key="key"}
                <tr>
                    <td>{$key}</td>
                    <td>{$_Klass->getData('name')}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" data-toggle="modal" data-target="#editKlass{$key}"><i class="glyphicon glyphicon-pencil"></i>&nbsp;编辑</button>
                        <a class="btn btn-sm btn-danger" href="{:url('delete?id=' . $_Klass->getData('id'))}"><i
                                class="glyphicon glyphicon-trash"></i>&nbsp;删除</a>

                        <div class="modal" id="editKlass{$key}" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only"></span></button>
                                        <h4 class="modal-title">编辑班级</h4>
                                    </div>
                                    <div class="modal-body">
                                        <form action="{:url('update')}" method="post">
                                            <label>班级名称：</label>
                                            <input type="hidden" name="id" value="{$_Klass->getData('id')}"/>
                                            <input type="text" name="name" id="name" value="{$_Klass->getData('name')}">
                                            <button type="submit" class="btn btn-primary">保存</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                {/volist}
            </table>
            {:$klasses->render()}
        </div>
    </div>
</div>
<script type="text/javascript" src="/labManageSystem/public/login/studentRegister.js"></script>
<script>
    function getMajor1() {
        var collegeNode = document.getElementById('college2');
        var majorNode = document.getElementById('major2');
        var name = "aCollege";//建立的input的name

        clear(majorNode);

        var collegeIndex = collegeNode.selectedIndex;
        var value = collegeNode[collegeIndex].value;
        var url = "/labmanagesystem/public/index/klass/getMajor?college=" + value;
        ajaxGet(url, function (response) {
            var majors = response;
            createOption(majorNode, majors);
            setSelected(majorNode);
            getGrade1();
        });
        creatInput(value, name, collegeNode);
    }

    function getGrade1() {
        var majorNode = document.getElementById('major2');
        var gradeNode = document.getElementById('grade2');
        var name = "aMajor";//建立的input的name

        clear(gradeNode);

        var majorIndex = majorNode.selectedIndex;
        var value = majorNode[majorIndex].value;
        var url = "/labmanagesystem/public/index/klass/getGrade?major=" + value;
        ajaxGet(url, function (response) {
            var grades = response;
            createOption(gradeNode, grades);
            setSelected(gradeNode);
            getKlass1();
        });
        creatInput(value, name, majorNode);
    }

    function getKlass1() {
        var gradeNode = document.getElementById('grade2');
        var name = "aGrade";//建立的input的name
        var gradeIndex = gradeNode.selectedIndex;
        var value = gradeNode[gradeIndex].value;
        creatInput(value, name, gradeNode);
    }

    //访问php函数，一个对象数组的返回值
    function ajaxGet(url, callback) {
        $.ajax({
            url: url,
            type: "get",
            success: function (response) {
                callback(response);
            },
            error: function (xhr) {
                console.log('server error');
            }
        });
    }

    //清除
    function clear(node) {
        node.length = 0;
    }

    //创建选项
    function createOption(node, inners, values) {
        for (var i = 0; i < inners.length; i++) {
            var option = document.createElement('option');

            option.value = inners[i].id;
            option.name = node;
            option.innerHTML = inners[i].name;
            node.appendChild(option);
        }
    }

    //设置选中状态
    function setSelected(node) {
        node.options[0].setAttribute("selected", "true");
    }

    //创建一个input按钮
    function creatInput(value, name, position) {
        var newInput = document.createElement("input");
        newInput.name = name;
        newInput.value = value;
        position.appendChild(newInput);
    }

    getMajor1();
</script>
{/block}